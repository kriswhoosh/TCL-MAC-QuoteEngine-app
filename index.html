<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCL-MAC Quote Engine</title>
    <link rel="icon" type="image/png" href="jo-jo-san.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>TCL-MAC Quote Engine</h1>
        
        <div class="card">
            <h3>Copy & Paste Route</h3>
            <textarea id="pcInput" placeholder="Example: DY10 4JB to CM77 8EF via B71 4EX"></textarea>
            <button onclick="parseText()" class="btn-primary">Parse Route</button>
        </div>

        <div class="card">
            <h3>Manual Controls</h3>
            <div class="input-group">
                <input type="text" id="pcA" placeholder="From (A)">
                <input type="text" id="pcB" placeholder="To (B)">
            </div>
            <input type="text" id="pcVia" placeholder="Waypoints (comma separated)">
            
            <div id="vehicleSelectors" class="chip-group">
                <button class="chip" onclick="selectVeh(this, 'SV')">SV</button>
                <button class="chip" onclick="selectVeh(this, 'LWB')">LWB</button>
                <button class="chip" onclick="selectVeh(this, '7.5t')">7.5t</button>
                </div>
            <input type="hidden" id="suggestedVehicle" value="LWB">

            <button id="btnCalc" class="btn-calc">Calculate Route</button>
            <button id="btnRateMate" style="display:none;" class="btn-purple">Generate Dual Quote</button>
        </div>

        <div class="card">
            <h3>Results</h3>
            <div id="status">Ready.</div>
            <div class="stat">Distance: <span id="distance">0.00</span></div>
        </div>

        <div id="rateMateCard" style="display:none;">
            <iframe id="rateMateFrame" style="width:100%; height:800px; border:none;"></div>
        </div>
    </div>
    <script>
// --- 1. Vehicle Selection Logic ---
window.selectVeh = function(btn, val) {
    const allChips = document.querySelectorAll('#vehicleSelectors .chip');
    allChips.forEach(c => {
        c.style.outline = 'none';
        c.style.background = 'rgba(255,255,255,0.05)';
    });
    btn.style.outline = '2px solid #ffd400';
    btn.style.background = 'rgba(255,212,0,0.2)';
    document.getElementById('suggestedVehicle').value = val;
};

// --- 2. The Waypoint Parser ---
function extractLocations(text) {
    const s = String(text || '');
    const m = s.match(/from\s+(.+?)\s+to\s+(.+?)(?:\s+via\s+(.+))?$/i);
    if (m) {
        return {
            from: m[1].trim().toUpperCase(),
            to: m[2].trim().toUpperCase(),
            via: m[3] ? m[3].split(/,|and|via/i).map(x => x.trim().toUpperCase()).filter(Boolean).join(', ') : ''
        };
    }
    return null;
}

window.parseText = function() {
    const input = document.getElementById('pcInput').value;
    const data = extractLocations(input);
    if (data) {
        document.getElementById('pcA').value = data.from;
        document.getElementById('pcB').value = data.to;
        document.getElementById('pcVia').value = data.via;
        document.getElementById('status').textContent = 'Text parsed! Now click Calculate.';
    } else {
        document.getElementById('status').textContent = 'Could not parse text pattern.';
    }
};

// --- 3. Routing Logic ---
document.getElementById('btnCalc').onclick = async () => {
    const from = document.getElementById('pcA').value.trim();
    const to = document.getElementById('pcB').value.trim();
    const viaRaw = document.getElementById('pcVia').value.trim();
    
    if(!from || !to) return;
    
    const viaPoints = viaRaw ? viaRaw.split(',').map(p => p.trim()).filter(p => p) : [];
    const allLocs = [from, ...viaPoints, to];
    document.getElementById('status').textContent = 'Geocoding...';
    
    try {
        const geoPoints = [];
        for (const loc of allLocs) {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(loc)}`).then(r => r.json());
            if (res.length > 0) geoPoints.push({ lat: res[0].lat, lon: res[0].lon, name: res[0].display_name.split(',')[0] });
        }

        const coordString = geoPoints.map(g => `${g.lon},${g.lat}`).join(';');
        const route = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordString}?overview=false`).then(r => r.json());
        
        if (route.code !== 'Ok') throw new Error('Routing failed');

        const distMiles = (route.routes[0].distance / 1609.344).toFixed(2);
        document.getElementById('routeAB').textContent = geoPoints.map(g => g.name).join(' â†’ ');
        document.getElementById('distance').textContent = distMiles + ' miles';
        window.currentWaypointCount = viaPoints.length;
        
        document.getElementById('status').textContent = 'Route ready!';
        document.getElementById('status').textContent = 'Route ready!';
        
        // Added safety check to prevent the "undefined" error
        if (typeof RateMate !== 'undefined') {
            RateMate.showButton();
        } else {
            console.log("Bridge not ready yet, retrying...");
            setTimeout(() => { if(typeof RateMate !== 'undefined') RateMate.showButton(); }, 500);
        }
    } catch(e) { 
        document.getElementById('status').textContent = 'Error: ' + e.message; 
    }
};

</script>
<script src="rate-mate-bridge.js"></script>
</body>
</html>